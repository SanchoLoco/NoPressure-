<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoPressure - Wound Management Platform</title>
    <style>
        /* Include ALL styles inline */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f4f8;
            color: #2d3748;
        }
        /* Navigation */
        nav {
            background: #1a365d;
            color: white;
            padding: 0 24px;
            display: flex;
            align-items: center;
            height: 64px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        nav .logo {
            font-size: 20px;
            font-weight: 700;
            color: #90cdf4;
            margin-right: 32px;
        }
        nav .logo span { color: white; }
        nav button {
            background: none;
            border: none;
            color: #bee3f8;
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        nav button:hover, nav button.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        nav .nav-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
        nav .offline-badge {
            background: #f6ad55;
            color: #744210;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        nav .online-badge {
            background: #68d391;
            color: #22543d;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        /* Page sections */
        .page { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }
        .page.active { display: block; }
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card h2 { font-size: 18px; font-weight: 600; color: #1a365d; margin-bottom: 16px; }
        .card h3 { font-size: 15px; font-weight: 600; color: #2d3748; margin-bottom: 12px; }
        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
        /* Stat cards */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .stat-card .value { font-size: 36px; font-weight: 700; color: #1a365d; }
        .stat-card .label { font-size: 13px; color: #718096; margin-top: 4px; }
        .stat-card .icon { font-size: 28px; margin-bottom: 8px; }
        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-green { background: #c6f6d5; color: #22543d; }
        .badge-yellow { background: #fefcbf; color: #744210; }
        .badge-red { background: #fed7d7; color: #742a2a; }
        .badge-orange { background: #feebc8; color: #7b341e; }
        .badge-blue { background: #bee3f8; color: #2a4365; }
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #3182ce; color: white; }
        .btn-primary:hover { background: #2b6cb0; }
        .btn-success { background: #38a169; color: white; }
        .btn-success:hover { background: #2f855a; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-danger:hover { background: #c53030; }
        .btn-outline { background: white; color: #3182ce; border: 2px solid #3182ce; }
        .btn-outline:hover { background: #ebf8ff; }
        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.2s;
            background: #f7fafc;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            background: white;
        }
        /* Progress bars */
        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 6px 0;
        }
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 14px; font-size: 12px; font-weight: 600; color: #718096; background: #f7fafc; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 12px 14px; font-size: 14px; border-top: 1px solid #e2e8f0; }
        tr:hover td { background: #f7fafc; }
        /* Capture interface */
        .capture-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .capture-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .capture-crosshair {
            width: 200px;
            height: 200px;
            border: 2px dashed rgba(255,255,255,0.6);
            border-radius: 50%;
            position: relative;
        }
        .capture-crosshair::before, .capture-crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.6);
        }
        .capture-crosshair::before { width: 1px; height: 100%; left: 50%; }
        .capture-crosshair::after { height: 1px; width: 100%; top: 50%; }
        .capture-guide {
            color: white;
            font-size: 13px;
            margin-top: 16px;
            text-align: center;
            padding: 8px 16px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
        }
        .angle-indicator {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
        }
        .angle-indicator.good { color: #68d391; }
        .angle-indicator.bad { color: #fc8181; }
        /* Body map */
        .body-map-container {
            display: flex;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        .body-map-svg {
            width: 200px;
            cursor: pointer;
        }
        .body-map-legend {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .alert-warning { background: #fefcbf; border-left: 4px solid #d69e2e; color: #744210; }
        .alert-danger { background: #fed7d7; border-left: 4px solid #c53030; color: #742a2a; }
        .alert-success { background: #c6f6d5; border-left: 4px solid #276749; color: #22543d; }
        .alert-info { background: #bee3f8; border-left: 4px solid #2b6cb0; color: #2a4365; }
        /* Timeline */
        .timeline { position: relative; padding-left: 24px; }
        .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: #3182ce; border: 2px solid white; box-shadow: 0 0 0 2px #3182ce; }
        .timeline-date { font-size: 12px; color: #718096; margin-bottom: 4px; }
        .timeline-content { font-size: 14px; }
        /* Healing chart */
        .chart-container { position: relative; height: 200px; }
        canvas { width: 100% !important; }
        /* Tissue legend */
        .tissue-legend { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; }
        .tissue-item { display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .tissue-dot { width: 14px; height: 14px; border-radius: 50%; }
        /* Voice button */
        .voice-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #3182ce;
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(49,130,206,0.4);
        }
        .voice-btn:hover { background: #2b6cb0; transform: scale(1.05); }
        .voice-btn.recording { background: #e53e3e; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(229,62,62,0.4); }
            50% { box-shadow: 0 4px 24px rgba(229,62,62,0.7); }
        }
        /* Stalled wound alert */
        .stalled-alert {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        /* Upload zone */
        .upload-zone {
            border: 2px dashed #90cdf4;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #ebf8ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover { border-color: #3182ce; background: #bee3f8; }
        .upload-zone input { display: none; }
        .upload-zone .upload-icon { font-size: 48px; margin-bottom: 12px; }
        /* Tabs */
        .tabs { display: flex; gap: 4px; background: #edf2f7; padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 8px 16px; border: none; background: none; cursor: pointer; border-radius: 8px; font-size: 14px; color: #718096; transition: all 0.2s; }
        .tab.active { background: white; color: #1a365d; font-weight: 600; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 28px; max-width: 480px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #1a365d; }
        .modal-close { float: right; background: none; border: none; font-size: 20px; cursor: pointer; color: #718096; }
        /* Treatment recommendation */
        .treatment-card {
            background: linear-gradient(135deg, #ebf8ff, #bee3f8);
            border: 1.5px solid #90cdf4;
            border-radius: 12px;
            padding: 16px;
        }
        .treatment-card .dressing { font-size: 18px; font-weight: 700; color: #1a365d; }
        .treatment-card .interventions { margin-top: 10px; }
        .treatment-card .intervention-item { 
            display: flex; align-items: flex-start; gap: 8px; 
            padding: 6px 0; border-bottom: 1px solid rgba(144,205,244,0.4);
            font-size: 13px;
        }
        .treatment-card .intervention-item:last-child { border-bottom: none; }
        /* Heading styles */
        h1 { font-size: 24px; font-weight: 700; color: #1a365d; margin-bottom: 8px; }
        .page-subtitle { font-size: 14px; color: #718096; margin-bottom: 24px; }
        /* Responsive video area */
        .video-placeholder {
            background: #1a202c;
            color: #a0aec0;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-height: 280px;
        }
        .video-placeholder .camera-icon { font-size: 56px; }
        /* Dressing tags */
        .dressing-chip {
            display: inline-block;
            padding: 4px 12px;
            background: #e9d8fd;
            color: #553c9a;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 3px;
        }
        /* Login page */
        .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1a365d, #2b6cb0); }
        .login-card { background: white; border-radius: 16px; padding: 40px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-card h1 { color: #1a365d; font-size: 28px; margin-bottom: 8px; }
        .login-card .subtitle { color: #718096; font-size: 14px; margin-bottom: 28px; }
        /* Severity score display */
        .severity-score-big { font-size: 64px; font-weight: 800; line-height: 1; }
        .severity-low { color: #38a169; }
        .severity-medium { color: #d69e2e; }
        .severity-high { color: #c53030; }
        /* Alert bell */
        .alert-bell-btn { position: relative; background: none; border: none; color: #bee3f8; font-size: 22px; cursor: pointer; padding: 8px; }
        .alert-bell-count { position: absolute; top: 2px; right: 2px; background: #e53e3e; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        /* Alert dropdown */
        .alert-dropdown { position: absolute; top: 60px; right: 16px; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 360px; z-index: 500; max-height: 400px; overflow-y: auto; display: none; }
        .alert-dropdown.open { display: block; }
        .alert-dropdown-header { padding: 14px 16px; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #1a365d; }
        .alert-item { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; cursor: pointer; }
        .alert-item:hover { background: #f7fafc; }
        .alert-item.unread { background: #ebf8ff; }
        .alert-item .alert-type { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #718096; }
        .alert-item .alert-msg { font-size: 13px; color: #2d3748; margin-top: 2px; }
        /* Camera */
        #camera-video { width: 100%; border-radius: 12px; }
        .camera-overlay-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 3px dashed rgba(255,255,255,0.7); border-radius: 50%; pointer-events: none; }
        /* Confirm/Override buttons */
        .confirm-btn { background: #38a169; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 8px; }
        .override-btn { background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- AUTH GUARD: shows login if not authenticated -->
<div id="login-overlay" class="login-page" style="display:none;">
    <div class="login-card">
        <h1>ü©π NoPressure</h1>
        <p class="subtitle">Wound Monitoring Platform ‚Äî Clinical Login</p>
        <div id="login-error" class="alert alert-danger" style="display:none;"></div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="clinician@hospital.org" />
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="doLogin()">Sign In</button>
        <p style="margin-top:16px;font-size:12px;color:#718096;text-align:center;">Demo: use any email / password ‚Äî auth is optional for dev mode</p>
    </div>
</div>

<nav id="main-nav">
    <div class="logo">No<span>Pressure</span></div>
    <button class="active" onclick="showPage('dashboard')">üìä Dashboard</button>
    <button onclick="showPage('capture')">üì∑ Scan Wound</button>
    <button onclick="showPage('patients-dashboard')">üë• Patients</button>
    <button onclick="showPage('analytics')">üìà Analytics</button>
    <button onclick="showPage('admin')">‚öôÔ∏è Admin</button>
    <div class="nav-right">
        <span id="connectivity-badge" class="online-badge">‚óè Online</span>
        <!-- Alert bell -->
        <button class="alert-bell-btn" onclick="toggleAlertDropdown()" id="alert-bell-btn">
            üîî
            <span class="alert-bell-count" id="alert-unread-count" style="display:none;">0</span>
        </button>
        <span id="nav-user-name" style="color:#bee3f8;font-size:13px;"></span>
        <button onclick="doLogout()" style="background:#e53e3e;color:white;border-radius:8px;font-size:12px;padding:6px 12px;">Logout</button>
        <button onclick="showPage('capture')" style="background:#3182ce;color:white;border-radius:8px;">+ New Scan</button>
    </div>
</nav>

<!-- Alert Dropdown -->
<div class="alert-dropdown" id="alert-dropdown">
    <div class="alert-dropdown-header">üîî Clinical Alerts <span id="alert-dropdown-count"></span></div>
    <div id="alert-dropdown-list"><div style="padding:16px;color:#718096;text-align:center;">No alerts</div></div>
</div>

<!-- DASHBOARD PAGE -->
<div id="page-dashboard" class="page active">
    <h1>Facility Command Center</h1>
    <p class="page-subtitle">Comprehensive wound burden overview ‚Äî Hadassah Medical Center</p>

    <div class="grid-4" style="margin-bottom:24px;">
        <div class="stat-card">
            <div class="icon">ü©π</div>
            <div class="value" id="stat-active">42</div>
            <div class="label">Active Wounds</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #fc8181;">
            <div class="icon">‚ö†Ô∏è</div>
            <div class="value" style="color:#c53030;" id="stat-stalled">7</div>
            <div class="label">Stalled Wounds</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #68d391;">
            <div class="icon">‚úÖ</div>
            <div class="value" style="color:#276749;" id="stat-healed">18</div>
            <div class="label">Healed This Month</div>
        </div>
        <div class="stat-card">
            <div class="icon">üìÖ</div>
            <div class="value" id="stat-avg">23</div>
            <div class="label">Avg Healing Days</div>
        </div>
    </div>

    <!-- Alerts -->
    <div class="stalled-alert">
        <strong>üö® Stalled Wound Alerts (7)</strong>
        <p style="margin-top:8px;font-size:13px;">The following wounds have not reduced by 20% in the past 28 days and require clinical review:</p>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;">
            <span class="badge badge-red">Mrs. Cohen - L Heel (Day 42)</span>
            <span class="badge badge-red">Mr. Levi - Sacral PU (Day 35)</span>
            <span class="badge badge-red">Mrs. Shapiro - R Foot DFU (Day 56)</span>
            <span class="badge badge-orange">Mr. Ben-David - Shin VLU (Day 29)</span>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h2>Wound Distribution by Type</h2>
            <canvas id="etiologyChart" height="200"></canvas>
        </div>
        <div class="card">
            <h2>Recent Activity</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-date">Today, 09:42</div>
                    <div class="timeline-content"><strong>New scan</strong> ‚Äî Mr. Katz, Diabetic Foot Ulcer<br><small style="color:#718096;">Nurse Sarah Cohen ‚Ä¢ Ward 4B</small></div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">Today, 08:15</div>
                    <div class="timeline-content"><strong>Stalled alert</strong> ‚Äî Mrs. Levi, Stage 3 Pressure Ulcer<br><small style="color:#718096;">PAR: 12% after 35 days</small></div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">Yesterday, 16:30</div>
                    <div class="timeline-content"><strong>Wound healed</strong> ‚Äî Mr. Friedman, Surgical Site<br><small style="color:#718096;">Total healing time: 18 days</small></div>
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">Yesterday, 14:20</div>
                    <div class="timeline-content"><strong>Treatment change</strong> ‚Äî Mrs. Cohen, Sacral Wound<br><small style="color:#718096;">Switched to Alginate dressing (high exudate)</small></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>All Patients ‚Äî Active Wound Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Wound Type</th>
                    <th>Location</th>
                    <th>Duration</th>
                    <th>PAR (4wk)</th>
                    <th>Status</th>
                    <th>Last Scan</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Mrs. Sarah Cohen</strong><br><small style="color:#718096;">MRN: 10045521</small></td>
                    <td>Pressure Ulcer</td>
                    <td>Left Heel</td>
                    <td>42 days</td>
                    <td><span style="color:#c53030;">12%</span></td>
                    <td><span class="badge badge-red">Stalled</span></td>
                    <td>Today</td>
                    <td><button class="btn btn-primary" style="font-size:12px;padding:6px 12px;" onclick="showPage('capture')">Scan</button></td>
                </tr>
                <tr>
                    <td><strong>Mr. David Levi</strong><br><small style="color:#718096;">MRN: 10038827</small></td>
                    <td>Diabetic Foot Ulcer</td>
                    <td>Right Toe</td>
                    <td>21 days</td>
                    <td><span style="color:#276749;">35%</span></td>
                    <td><span class="badge badge-green">Healing</span></td>
                    <td>2 days ago</td>
                    <td><button class="btn btn-primary" style="font-size:12px;padding:6px 12px;" onclick="showPage('capture')">Scan</button></td>
                </tr>
                <tr>
                    <td><strong>Mrs. Ruth Ben-David</strong><br><small style="color:#718096;">MRN: 10051209</small></td>
                    <td>Venous Leg Ulcer</td>
                    <td>Left Shin</td>
                    <td>15 days</td>
                    <td><span style="color:#276749;">28%</span></td>
                    <td><span class="badge badge-green">Healing</span></td>
                    <td>Yesterday</td>
                    <td><button class="btn btn-primary" style="font-size:12px;padding:6px 12px;" onclick="showPage('capture')">Scan</button></td>
                </tr>
                <tr>
                    <td><strong>Mr. Yosef Katz</strong><br><small style="color:#718096;">MRN: 10029834</small></td>
                    <td>Surgical Site</td>
                    <td>Abdomen</td>
                    <td>8 days</td>
                    <td>‚Äî</td>
                    <td><span class="badge badge-blue">Active</span></td>
                    <td>Today</td>
                    <td><button class="btn btn-primary" style="font-size:12px;padding:6px 12px;" onclick="showPage('capture')">Scan</button></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- CAPTURE PAGE -->
<div id="page-capture" class="page">
    <h1>Guided Wound Capture</h1>
    <p class="page-subtitle">AI-powered scan with automated tissue segmentation and 3D measurement</p>

    <div class="grid-2">
        <div>
            <!-- Camera guidance -->
            <div class="card">
                <h2>üì∑ Camera Guidance</h2>
                <div class="capture-container" style="position:relative;">
                    <div id="camera-placeholder" class="video-placeholder">
                        <div class="camera-icon">üì∑</div>
                        <p>Tap to start camera</p>
                        <button class="btn btn-primary" onclick="startCamera()">Start Camera</button>
                    </div>
                    <video id="camera-video" autoplay playsinline style="display:none;width:100%;border-radius:12px;"></video>
                    <div class="camera-overlay-circle" style="pointer-events:none;"></div>
                </div>
                <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
                    <button id="capture-btn" class="btn btn-success" style="display:none;" onclick="capturePhoto()">üì∏ Capture Photo</button>
                    <div id="capture-preview"></div>
                    <span id="camera-captured-indicator" style="display:none;color:#38a169;font-weight:600;">‚úÖ Photo captured</span>
                </div>
                <div style="margin-top:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:13px;font-weight:600;">Capture Quality Checks</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <div style="display:flex;align-items:center;gap:8px;font-size:13px;">
                            <span id="check-angle" style="color:#38a169;">‚úÖ</span> Camera angle: 90¬∞ (perpendicular)
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;font-size:13px;">
                            <span id="check-calibration" style="color:#38a169;">‚úÖ</span> Calibration marker detected
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;font-size:13px;">
                            <span id="check-focus" style="color:#38a169;">‚úÖ</span> Image focus: Sharp
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;font-size:13px;">
                            <span id="check-lighting" style="color:#f6ad55;">‚ö°</span> Lighting: Suboptimal (move to brighter area)
                        </div>
                    </div>
                </div>
                <div style="margin-top:16px;text-align:center;">
                    <label class="upload-zone" for="imageUpload">
                        <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
                        <div class="upload-icon">üì§</div>
                        <div style="font-weight:600;color:#2b6cb0;">Upload Wound Image</div>
                        <div style="font-size:12px;color:#718096;margin-top:4px;">Tap to select image ‚Ä¢ Never saved to gallery</div>
                    </label>
                    <div id="image-preview" style="display:none;margin-top:12px;">
                        <img id="preview-img" style="max-width:100%;border-radius:8px;max-height:200px;" alt="Wound preview">
                    </div>
                </div>
            </div>

            <!-- Patient & wound info -->
            <div class="card">
                <h2>Patient & Wound Information</h2>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Patient</label>
                        <select id="scan-patient">
                            <option value="">Select patient...</option>
                            <option value="p1">Mrs. Sarah Cohen (MRN: 10045521)</option>
                            <option value="p2">Mr. David Levi (MRN: 10038827)</option>
                            <option value="p3">Mrs. Ruth Ben-David (MRN: 10051209)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Wound Type (Etiology)</label>
                        <select id="scan-etiology">
                            <option value="pressure_ulcer">Pressure Ulcer</option>
                            <option value="diabetic_foot_ulcer">Diabetic Foot Ulcer</option>
                            <option value="venous_leg_ulcer">Venous Leg Ulcer</option>
                            <option value="surgical_site_infection">Surgical Site Infection</option>
                            <option value="arterial_ulcer">Arterial Ulcer</option>
                            <option value="traumatic">Traumatic Wound</option>
                            <option value="burn">Burn</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Body Location</label>
                        <select id="scan-location">
                            <option value="sacrum">Sacrum</option>
                            <option value="left_heel">Left Heel</option>
                            <option value="right_heel">Right Heel</option>
                            <option value="left_foot">Left Foot</option>
                            <option value="right_foot">Right Foot</option>
                            <option value="left_shin">Left Shin</option>
                            <option value="right_shin">Right Shin</option>
                            <option value="abdomen">Abdomen</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Scanned By</label>
                        <input type="text" id="scan-nurse" value="Nurse Sarah Cohen" placeholder="Clinician name">
                    </div>
                </div>
                <div class="form-group">
                    <label>Clinical Notes (Voice-to-Text)</label>
                    <div style="display:flex;gap:12px;align-items:flex-start;">
                        <textarea id="scan-notes" rows="3" placeholder="Type clinical observations or use microphone for voice-to-text..."></textarea>
                        <button class="voice-btn" id="voice-btn" onclick="toggleVoiceRecording()" title="Voice-to-Text">üé§</button>
                    </div>
                    <div id="voice-status" style="font-size:12px;color:#718096;margin-top:4px;"></div>
                </div>
                <button class="btn btn-success" style="width:100%;padding:14px;" onclick="runAIScan()">
                    üî¨ Run AI Analysis
                </button>
            </div>
        </div>

        <div>
            <!-- AI Results -->
            <div class="card" id="ai-results-card" style="display:none;">
                <h2>ü§ñ AI Analysis Results</h2>

                <div class="grid-2" style="margin-bottom:16px;">
                    <div style="background:#f7fafc;border-radius:8px;padding:12px;">
                        <div style="font-size:12px;color:#718096;font-weight:600;">LENGTH</div>
                        <div style="font-size:22px;font-weight:700;color:#1a365d;" id="res-length">3.2 cm</div>
                    </div>
                    <div style="background:#f7fafc;border-radius:8px;padding:12px;">
                        <div style="font-size:12px;color:#718096;font-weight:600;">WIDTH</div>
                        <div style="font-size:22px;font-weight:700;color:#1a365d;" id="res-width">2.1 cm</div>
                    </div>
                    <div style="background:#f7fafc;border-radius:8px;padding:12px;">
                        <div style="font-size:12px;color:#718096;font-weight:600;">AREA</div>
                        <div style="font-size:22px;font-weight:700;color:#1a365d;" id="res-area">5.3 cm¬≤</div>
                    </div>
                    <div style="background:#f7fafc;border-radius:8px;padding:12px;">
                        <div style="font-size:12px;color:#718096;font-weight:600;">DEPTH</div>
                        <div style="font-size:22px;font-weight:700;color:#1a365d;" id="res-depth">0.4 cm</div>
                    </div>
                </div>

                <h3>Tissue Composition (AI Segmentation)</h3>
                <div id="tissue-bars">
                    <div>
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:3px;">
                            <span>üî¥ Granulation (Healthy)</span><span id="pct-granulation">60%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar-granulation" style="width:60%;background:#fc8181;"></div>
                        </div>
                    </div>
                    <div style="margin-top:8px;">
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:3px;">
                            <span>üü° Slough (Fibrinous)</span><span id="pct-slough">25%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar-slough" style="width:25%;background:#f6e05e;"></div>
                        </div>
                    </div>
                    <div style="margin-top:8px;">
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:3px;">
                            <span>‚ö´ Eschar (Necrotic)</span><span id="pct-eschar">10%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar-eschar" style="width:10%;background:#4a5568;"></div>
                        </div>
                    </div>
                    <div style="margin-top:8px;">
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:3px;">
                            <span>ü©∑ Epithelial (New Skin)</span><span id="pct-epithelial">5%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar-epithelial" style="width:5%;background:#fc8181;opacity:0.5;"></div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:16px;">
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:120px;background:#f7fafc;border-radius:8px;padding:10px;">
                            <div style="font-size:11px;color:#718096;font-weight:600;">EXUDATE</div>
                            <div style="font-size:15px;font-weight:600;" id="res-exudate">Moderate / Serous</div>
                        </div>
                        <div style="flex:1;min-width:120px;background:#f7fafc;border-radius:8px;padding:10px;">
                            <div style="font-size:11px;color:#718096;font-weight:600;">SUB-EPIDERMAL RISK</div>
                            <div style="font-size:15px;font-weight:600;" id="res-risk">Low</div>
                        </div>
                        <div style="flex:1;min-width:120px;background:#f7fafc;border-radius:8px;padding:10px;">
                            <div style="font-size:11px;color:#718096;font-weight:600;">MEASUREMENT ERROR</div>
                            <div style="font-size:15px;font-weight:600;color:#276749;">2.5% ‚úì</div>
                        </div>
                    </div>
                </div>

                <div id="sub-epidermal-alert" style="display:none;margin-top:12px;" class="alert alert-warning">
                    ‚ö†Ô∏è <div><strong>Sub-Epidermal Risk Detected</strong><br>Persistent redness or temperature change detected. Early Stage 1 pressure injury possible. Initiate prevention protocol.</div>
                </div>

                <div style="margin-top:16px;">
                    <h3>Treatment Recommendation</h3>
                    <div class="treatment-card">
                        <div style="font-size:12px;color:#2b6cb0;font-weight:600;text-transform:uppercase;">Primary Dressing</div>
                        <div class="dressing" id="res-dressing">Foam Dressing with Superabsorbent Layer</div>
                        <div class="interventions" id="res-interventions">
                            <div class="intervention-item">‚úì High exudate detected; recommend Alginate dressing</div>
                            <div class="intervention-item">‚úì Debridement of fibrinous tissue required</div>
                            <div class="intervention-item">‚úì Compression therapy: 40mmHg four-layer bandaging</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:16px;display:flex;gap:10px;">
                    <button class="btn btn-primary" style="flex:1;" onclick="saveScan()">üíæ Save Scan</button>
                    <button class="btn btn-outline" style="flex:1;" onclick="exportPDF()">üìÑ Export PDF / EHR</button>
                </div>
            </div>

            <!-- Body Map -->
            <div class="card">
                <h2>üìç Body Map ‚Äî Pin Wound Location</h2>
                <div class="body-map-container">
                    <svg class="body-map-svg" viewBox="0 0 100 220" onclick="handleBodyMapClick(event)">
                        <!-- Head -->
                        <ellipse cx="50" cy="15" rx="14" ry="16" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1.5"/>
                        <!-- Neck -->
                        <rect x="44" y="29" width="12" height="10" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1"/>
                        <!-- Torso -->
                        <rect x="28" y="38" width="44" height="55" rx="6" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1.5"/>
                        <!-- Left arm -->
                        <rect x="10" y="40" width="18" height="55" rx="7" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1.5"/>
                        <!-- Right arm -->
                        <rect x="72" y="40" width="18" height="55" rx="7" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1.5"/>
                        <!-- Left leg -->
                        <rect x="28" y="96" width="19" height="80" rx="7" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1.5"/>
                        <!-- Right leg -->
                        <rect x="53" y="96" width="19" height="80" rx="7" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1.5"/>
                        <!-- Left foot -->
                        <ellipse cx="37" cy="184" rx="10" ry="6" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1"/>
                        <!-- Right foot -->
                        <ellipse cx="62" cy="184" rx="10" ry="6" fill="#fbd38d" stroke="#e2e8f0" stroke-width="1"/>
                        <!-- Labels -->
                        <text x="50" y="60" text-anchor="middle" fill="#718096" font-size="6">Torso</text>
                        <text x="19" y="65" text-anchor="middle" fill="#718096" font-size="5">L Arm</text>
                        <text x="81" y="65" text-anchor="middle" fill="#718096" font-size="5">R Arm</text>
                        <text x="37" y="140" text-anchor="middle" fill="#718096" font-size="5">L Leg</text>
                        <text x="62" y="140" text-anchor="middle" fill="#718096" font-size="5">R Leg</text>
                        <!-- Wound pins -->
                        <circle id="pin-1" cx="37" cy="178" r="5" fill="#e53e3e" stroke="white" stroke-width="1.5" style="display:none"/>
                        <circle id="pin-2" cx="62" cy="178" r="5" fill="#e53e3e" stroke="white" stroke-width="1.5" style="display:none"/>
                        <circle id="active-pin" cx="0" cy="0" r="6" fill="#e53e3e" stroke="white" stroke-width="2" opacity="0.9" style="display:none"/>
                    </svg>
                </div>
                <p style="font-size:12px;color:#718096;text-align:center;">Click on the body to pin wound location</p>
                <div id="body-map-pins" style="margin-top:12px;"></div>
            </div>
        </div>
    </div>
    <!-- AI Result Confirm / Override Panel -->
    <div id="confirm-override-panel" class="card" style="display:none;margin-top:16px;border:2px solid #3182ce;">
        <h2>ü©∫ Clinician Review Required</h2>
        <p style="color:#718096;margin-bottom:12px;">Review the AI-generated results below and confirm or override.</p>
        <div class="grid-2" style="margin-bottom:16px;">
            <div style="text-align:center;">
                <div style="font-size:13px;color:#718096;">AI Severity Score</div>
                <div class="severity-score-big severity-medium" id="current-severity-display">‚Äî</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:13px;color:#718096;">AI Stage</div>
                <div style="font-size:24px;font-weight:700;color:#1a365d;" id="current-stage-display">‚Äî</div>
            </div>
        </div>
        <button class="confirm-btn" onclick="confirmScan()">‚úÖ Confirm AI Result</button>
        <button class="override-btn" onclick="overrideScan()">‚úèÔ∏è Override with Clinical Judgment</button>
    </div>
</div>

<!-- PATIENTS PAGE -->
<div id="page-patients" class="page">
    <h1>Patient Management</h1>
    <p class="page-subtitle">Manage patient records and wound histories</p>
    <div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
        <button class="btn btn-primary" onclick="document.getElementById('add-patient-modal').classList.add('open')">+ Add Patient</button>
    </div>
    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Patient Name</th>
                    <th>MRN</th>
                    <th>Active Wounds</th>
                    <th>Facility</th>
                    <th>Last Activity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Mrs. Sarah Cohen</strong></td>
                    <td>10045521</td>
                    <td><span class="badge badge-red">2 (1 stalled)</span></td>
                    <td>Ward 4B</td>
                    <td>Today</td>
                    <td>
                        <button class="btn btn-outline" style="font-size:12px;padding:5px 10px;" onclick="showPage('analytics')">View History</button>
                        <button class="btn btn-primary" style="font-size:12px;padding:5px 10px;margin-left:6px;" onclick="showPage('capture')">New Scan</button>
                    </td>
                </tr>
                <tr>
                    <td><strong>Mr. David Levi</strong></td>
                    <td>10038827</td>
                    <td><span class="badge badge-green">1 (healing)</span></td>
                    <td>Ward 2A</td>
                    <td>2 days ago</td>
                    <td>
                        <button class="btn btn-outline" style="font-size:12px;padding:5px 10px;" onclick="showPage('analytics')">View History</button>
                        <button class="btn btn-primary" style="font-size:12px;padding:5px 10px;margin-left:6px;" onclick="showPage('capture')">New Scan</button>
                    </td>
                </tr>
                <tr>
                    <td><strong>Mrs. Ruth Ben-David</strong></td>
                    <td>10051209</td>
                    <td><span class="badge badge-green">1 (healing)</span></td>
                    <td>Outpatient Clinic</td>
                    <td>Yesterday</td>
                    <td>
                        <button class="btn btn-outline" style="font-size:12px;padding:5px 10px;" onclick="showPage('analytics')">View History</button>
                        <button class="btn btn-primary" style="font-size:12px;padding:5px 10px;margin-left:6px;" onclick="showPage('capture')">New Scan</button>
                    </td>
                </tr>
                <tr>
                    <td><strong>Mr. Yosef Katz</strong></td>
                    <td>10029834</td>
                    <td><span class="badge badge-blue">1 (active)</span></td>
                    <td>Surgical Ward</td>
                    <td>Today</td>
                    <td>
                        <button class="btn btn-outline" style="font-size:12px;padding:5px 10px;" onclick="showPage('analytics')">View History</button>
                        <button class="btn btn-primary" style="font-size:12px;padding:5px 10px;margin-left:6px;" onclick="showPage('capture')">New Scan</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ANALYTICS PAGE -->
<div id="page-analytics" class="page">
    <h1>Healing Trend Analytics</h1>
    <p class="page-subtitle">PAR tracking, time-lapse comparisons, and predictive healing projections</p>

    <div class="tabs">
        <button class="tab active" onclick="switchTab(this,'tab-trend')">üìà Healing Trend</button>
        <button class="tab" onclick="switchTab(this,'tab-comparison')">üîç Side-by-Side</button>
        <button class="tab" onclick="switchTab(this,'tab-timelapse')">üéûÔ∏è Time-Lapse</button>
    </div>

    <div id="tab-trend">
        <div class="grid-2">
            <div class="card">
                <h2>Select Patient & Wound</h2>
                <div class="form-group">
                    <label>Patient</label>
                    <select onchange="updateAnalytics()">
                        <option>Mrs. Sarah Cohen ‚Äî Pressure Ulcer (Left Heel)</option>
                        <option>Mr. David Levi ‚Äî Diabetic Foot Ulcer</option>
                        <option>Mrs. Ruth Ben-David ‚Äî Venous Leg Ulcer</option>
                    </select>
                </div>
                <div style="background:#f7fafc;border-radius:10px;padding:16px;margin-top:8px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                        <span style="font-size:13px;color:#718096;">Baseline Area:</span>
                        <strong>8.4 cm¬≤</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                        <span style="font-size:13px;color:#718096;">Current Area:</span>
                        <strong>7.4 cm¬≤</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                        <span style="font-size:13px;color:#718096;">PAR (4 weeks):</span>
                        <strong style="color:#c53030;">12.0% ‚ö†Ô∏è</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                        <span style="font-size:13px;color:#718096;">Days Elapsed:</span>
                        <strong>42 days</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="font-size:13px;color:#718096;">Projection:</span>
                        <strong>~240 days (stalled)</strong>
                    </div>
                    <div class="alert alert-danger" style="margin-top:12px;">
                        üö® <div><strong>Stalled Wound Alert</strong><br>Wound has not reduced by 20% in 28 days. Clinical review required. Consider biopsy, NPWT, or advanced therapy.</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Wound Area Over Time</h2>
                <canvas id="healingChart" height="220"></canvas>
                <div style="display:flex;gap:16px;margin-top:8px;font-size:12px;">
                    <span>üìâ Area trend</span>
                    <span style="color:#fc8181;">‚Äî Stall threshold (20% reduction)</span>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-comparison" style="display:none;">
        <div class="card">
            <h2>Side-by-Side Wound Comparison</h2>
            <div class="grid-2">
                <div>
                    <h3>Day 1 ‚Äî Baseline</h3>
                    <div style="background:#e2e8f0;border-radius:10px;height:200px;display:flex;align-items:center;justify-content:center;color:#718096;font-size:13px;">
                        üì∑ Baseline scan image<br><small>Area: 8.4 cm¬≤ ¬∑ Granulation: 30%</small>
                    </div>
                    <div style="margin-top:12px;font-size:13px;">
                        <div>Length: 3.8 cm ¬∑ Width: 2.8 cm</div>
                        <div>Tissue: 30% granulation, 50% slough, 20% eschar</div>
                        <div>Exudate: High</div>
                    </div>
                </div>
                <div>
                    <h3>Today ‚Äî Day 42</h3>
                    <div style="background:#e2e8f0;border-radius:10px;height:200px;display:flex;align-items:center;justify-content:center;color:#718096;font-size:13px;">
                        üì∑ Current scan image<br><small>Area: 7.4 cm¬≤ ¬∑ Granulation: 60%</small>
                    </div>
                    <div style="margin-top:12px;font-size:13px;">
                        <div>Length: 3.2 cm ¬∑ Width: 2.9 cm</div>
                        <div>Tissue: 60% granulation, 25% slough, 10% eschar, 5% epithelial</div>
                        <div>Exudate: Moderate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-timelapse" style="display:none;">
        <div class="card">
            <h2>üéûÔ∏è Wound Time-Lapse</h2>
            <div style="text-align:center;padding:40px;">
                <div style="font-size:48px;margin-bottom:16px;">üéûÔ∏è</div>
                <p style="color:#718096;">Time-lapse animation of wound progression</p>
                <p style="font-size:13px;color:#a0aec0;margin-top:8px;">6 scans over 42 days</p>
                <button class="btn btn-primary" style="margin-top:16px;">‚ñ∂Ô∏è Play Time-Lapse</button>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page">
    <h1>Administration & Compliance</h1>
    <p class="page-subtitle">Audit trail, resource management, and system settings</p>

    <div class="grid-2">
        <div class="card">
            <h2>üîí HIPAA/GDPR Compliance</h2>
            <div style="display:flex;flex-direction:column;gap:10px;font-size:14px;">
                <div style="display:flex;justify-content:space-between;padding:10px;background:#c6f6d5;border-radius:8px;">
                    <span>PHI Encryption (AES-256)</span><span>‚úÖ Active</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:#c6f6d5;border-radius:8px;">
                    <span>TLS 1.3 In-Transit Encryption</span><span>‚úÖ Active</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:#c6f6d5;border-radius:8px;">
                    <span>Zero-Footprint Storage</span><span>‚úÖ Enabled</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:#c6f6d5;border-radius:8px;">
                    <span>FHIR R4 EHR Integration</span><span>‚úÖ Connected</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:#fefcbf;border-radius:8px;">
                    <span>Offline Sync Queue</span><span>‚ö° 3 pending</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìã Audit Trail</h2>
            <table>
                <thead>
                    <tr><th>User</th><th>Action</th><th>Resource</th><th>Time</th></tr>
                </thead>
                <tbody>
                    <tr><td>Nurse S. Cohen</td><td>Created scan</td><td>Scan #8821</td><td>09:42</td></tr>
                    <tr><td>Dr. R. Katz</td><td>Viewed record</td><td>Patient #10045521</td><td>09:35</td></tr>
                    <tr><td>Nurse M. Levi</td><td>Updated notes</td><td>Wound #W-442</td><td>08:20</td></tr>
                    <tr><td>System</td><td>Stalled alert</td><td>Wound #W-391</td><td>08:15</td></tr>
                    <tr><td>Nurse S. Cohen</td><td>Exported PDF</td><td>Scan #8810</td><td>Yesterday</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>üíä Dressing Inventory & Usage</h2>
            <table>
                <thead>
                    <tr><th>Dressing Type</th><th>Used (Month)</th><th>Stock</th><th>Forecast</th></tr>
                </thead>
                <tbody>
                    <tr><td>Alginate Dressing</td><td>47 units</td><td><span class="badge badge-green">142 left</span></td><td>~50/month</td></tr>
                    <tr><td>Foam Dressing</td><td>83 units</td><td><span class="badge badge-yellow">34 left</span></td><td>Reorder needed</td></tr>
                    <tr><td>Hydrocolloid</td><td>22 units</td><td><span class="badge badge-green">98 left</span></td><td>~25/month</td></tr>
                    <tr><td>Hydrogel</td><td>15 units</td><td><span class="badge badge-red">8 left</span></td><td>üö® Urgent reorder</td></tr>
                    <tr><td>Silicone Foam</td><td>38 units</td><td><span class="badge badge-green">71 left</span></td><td>~40/month</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>üåê EHR Integration Status</h2>
            <div style="display:flex;flex-direction:column;gap:10px;font-size:14px;">
                <div style="padding:12px;background:#f7fafc;border-radius:8px;">
                    <div style="font-weight:600;">Epic EMR (Primary)</div>
                    <div style="color:#38a169;font-size:13px;margin-top:4px;">‚úÖ Connected ¬∑ FHIR R4 ¬∑ Last sync: 2 min ago</div>
                </div>
                <div style="padding:12px;background:#f7fafc;border-radius:8px;">
                    <div style="font-weight:600;">Clalit HMO System</div>
                    <div style="color:#38a169;font-size:13px;margin-top:4px;">‚úÖ Connected ¬∑ HL7 v2.7 ¬∑ Last sync: 15 min ago</div>
                </div>
                <div style="padding:12px;background:#f7fafc;border-radius:8px;">
                    <div style="font-weight:600;">Offline Sync Queue</div>
                    <div style="color:#d69e2e;font-size:13px;margin-top:4px;">‚è≥ 3 records pending ¬∑ Will sync on reconnect</div>
                </div>
                <button class="btn btn-primary" style="margin-top:8px;">Force Sync Now</button>
            </div>
        </div>
    </div>
    <!-- Audit Log Viewer -->
    <div id="admin-auditlog-section" class="card" style="margin-top:20px;">
        <h2>Audit Log Viewer</h2>
        <p style="color:#718096;font-size:13px;margin-bottom:12px;">HIPAA-compliant access log for all PHI endpoints. Admin only.</p>
        <table>
            <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Resource Type</th><th>Resource ID</th><th>IP Address</th></tr></thead>
            <tbody id="audit-log-tbody"><tr><td colspan="6" style="text-align:center;color:#718096;padding:24px;">Select Admin tab to load audit logs</td></tr></tbody>
        </table>
    </div>
</div>

<!-- Add Patient Modal -->
<div class="modal-overlay" id="add-patient-modal">
    <div class="modal">
        <button class="modal-close" onclick="document.getElementById('add-patient-modal').classList.remove('open')">‚úï</button>
        <h2>Add New Patient</h2>
        <div class="form-group"><label>Medical Record Number (MRN)</label><input type="text" placeholder="e.g., 10056789"></div>
        <div class="grid-2">
            <div class="form-group"><label>First Name</label><input type="text" placeholder="First name"></div>
            <div class="form-group"><label>Last Name</label><input type="text" placeholder="Last name"></div>
        </div>
        <div class="grid-2">
            <div class="form-group"><label>Date of Birth</label><input type="date"></div>
            <div class="form-group"><label>Gender</label>
                <select><option>Male</option><option>Female</option><option>Other</option></select>
            </div>
        </div>
        <div class="form-group"><label>Facility / Ward</label><input type="text" placeholder="e.g., Ward 4B"></div>
        <button class="btn btn-primary" style="width:100%;" onclick="document.getElementById('add-patient-modal').classList.remove('open')">Add Patient</button>
    </div>
</div>

<!-- PATIENT DASHBOARD PAGE -->
<div id="page-patients-dashboard" class="page">
    <h1>Patient Dashboard</h1>
    <p class="page-subtitle">Search patients and view wound summaries</p>
    <div class="card">
        <div style="display:flex;gap:12px;margin-bottom:16px;">
            <input type="text" id="patient-search-input" placeholder="Search by name or MRN..." style="flex:1;padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:14px;" oninput="searchPatients(this.value)"/>
            <button class="btn btn-primary" onclick="searchPatients(document.getElementById('patient-search-input').value)">üîç Search</button>
            <button class="btn btn-success" onclick="showAddPatientModal()">+ Add Patient</button>
        </div>
        <div id="patient-list-container">
            <table id="patient-table">
                <thead><tr><th>Patient</th><th>MRN</th><th>Facility</th><th>Wounds</th><th>Latest Severity</th><th>Actions</th></tr></thead>
                <tbody id="patient-table-body"><tr><td colspan="6" style="text-align:center;color:#718096;padding:24px;">Loading patients...</td></tr></tbody>
            </table>
        </div>
    </div>
    <!-- Wound summary for selected patient -->
    <div id="wound-summary-card" class="card" style="display:none;">
        <h2 id="wound-summary-title">Wounds for Patient</h2>
        <button class="btn btn-success" style="margin-bottom:12px;" onclick="showAddWoundModal()">+ Add New Wound</button>
        <div id="wound-summary-list"></div>
    </div>
</div>

<!-- WOUND TIMELINE PAGE -->
<div id="page-wound-timeline" class="page">
    <h1>Wound Timeline</h1>
    <p class="page-subtitle" id="timeline-subtitle">Severity progression over time</p>
    <div class="card">
        <canvas id="timeline-chart" height="120"></canvas>
    </div>
    <div class="card">
        <h2>Scan History</h2>
        <div id="timeline-scan-list"></div>
    </div>
</div>

<script>
    // Navigation
    function showPage(name) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('page-' + name).classList.add('active');
        const navBtns = document.querySelectorAll('nav button');
        const pageNames = ['dashboard', 'capture', 'patients', 'analytics', 'admin'];
        const idx = pageNames.indexOf(name);
        if (idx >= 0) navBtns[idx].classList.add('active');
        if (name === 'analytics') setTimeout(drawCharts, 100);
        if (name === 'dashboard') setTimeout(drawDashboardChart, 100);
    }

    // Tabs
    function switchTab(btn, tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        ['tab-trend', 'tab-comparison', 'tab-timelapse'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById(tabId).style.display = 'block';
        if (tabId === 'tab-trend') setTimeout(() => drawHealingChart(), 100);
    }

    // Image upload preview
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // Body map click
    function handleBodyMapClick(event) {
        const svg = event.currentTarget;
        const rect = svg.getBoundingClientRect();
        const scaleX = 100 / rect.width;
        const scaleY = 220 / rect.height;
        const x = (event.clientX - rect.left) * scaleX;
        const y = (event.clientY - rect.top) * scaleY;

        const pin = document.getElementById('active-pin');
        pin.setAttribute('cx', x);
        pin.setAttribute('cy', y);
        pin.style.display = 'block';

        document.getElementById('body-map-pins').innerHTML =
            `<div class="alert alert-info">üìç Wound location pinned at coordinates (${x.toFixed(0)}, ${y.toFixed(0)})</div>`;
    }

    // Voice recording simulation
    let isRecording = false;
    let recognitionInterval = null;
    const voicePhrases = [
        "Wound showing signs of improvement with healthy granulation tissue...",
        "Patient reports mild pain at site, no signs of infection...",
        "Moderate exudate present, dressing changed with alginate...",
        "Periwound skin intact with slight maceration noted..."
    ];
    function toggleVoiceRecording() {
        const btn = document.getElementById('voice-btn');
        const status = document.getElementById('voice-status');
        isRecording = !isRecording;
        if (isRecording) {
            btn.classList.add('recording');
            btn.textContent = '‚èπÔ∏è';
            status.textContent = 'üéôÔ∏è Recording... speak your clinical notes';
            let phraseIdx = 0;
            recognitionInterval = setInterval(() => {
                if (phraseIdx < voicePhrases.length) {
                    const notes = document.getElementById('scan-notes');
                    notes.value = (notes.value ? notes.value + ' ' : '') + voicePhrases[phraseIdx++];
                }
            }, 1500);
        } else {
            btn.classList.remove('recording');
            btn.textContent = 'üé§';
            status.textContent = '‚úÖ Voice input saved';
            clearInterval(recognitionInterval);
        }
    }

    // AI Scan simulation
    function runAIScan() {
        const results = document.getElementById('ai-results-card');
        results.style.display = 'block';
        // Simulate different results
        const scenarios = [
            { gran: 60, slough: 25, eschar: 10, epi: 5, exudate: 'Moderate / Serous', risk: 'Low', dressing: 'Foam Dressing with Superabsorbent Layer' },
            { gran: 30, slough: 55, eschar: 10, epi: 5, exudate: 'High / Serosanguineous', risk: 'None', dressing: 'Alginate Dressing' },
            { gran: 20, slough: 30, eschar: 45, epi: 5, exudate: 'Low / Serous', risk: 'Moderate', dressing: 'Hydrocolloid or Enzymatic Debridement Agent' },
        ];
        const s = scenarios[Math.floor(Math.random() * scenarios.length)];
        document.getElementById('bar-granulation').style.width = s.gran + '%';
        document.getElementById('pct-granulation').textContent = s.gran + '%';
        document.getElementById('bar-slough').style.width = s.slough + '%';
        document.getElementById('pct-slough').textContent = s.slough + '%';
        document.getElementById('bar-eschar').style.width = s.eschar + '%';
        document.getElementById('pct-eschar').textContent = s.eschar + '%';
        document.getElementById('bar-epithelial').style.width = s.epi + '%';
        document.getElementById('pct-epithelial').textContent = s.epi + '%';
        document.getElementById('res-exudate').textContent = s.exudate;
        document.getElementById('res-risk').textContent = s.risk;
        document.getElementById('res-dressing').textContent = s.dressing;
        if (s.risk === 'Moderate' || s.risk === 'High') {
            document.getElementById('sub-epidermal-alert').style.display = 'flex';
        }
        results.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Show AI result severity score (mock: 2.7)
        const mockSeverity = (Math.random() * 2 + 1.5).toFixed(1);
        const mockStage = ['Stage 1','Stage 2','Stage 3'][Math.floor(Math.random()*3)];
        // Show confirm/override panel (with a mock scan ID for demo)
        currentScanId = 'demo-scan-' + Date.now();
        showConfirmOverride(currentScanId, parseFloat(mockSeverity), mockStage);
        // Display severity score prominently
        const severityEl = document.createElement('div');
        severityEl.style.cssText = 'text-align:center;margin:12px 0;';
        severityEl.innerHTML = `<div style="font-size:13px;color:#718096;">AI Severity Score</div><div class="severity-score-big ${parseFloat(mockSeverity)>=3?'severity-high':parseFloat(mockSeverity)>=2?'severity-medium':'severity-low'}">${mockSeverity}</div><div style="font-size:13px;color:#718096;">${mockStage} ‚Ä¢ Confidence: 94%</div>`;
        results.insertBefore(severityEl, results.firstChild);
    }

    function saveScan() {
        alert('‚úÖ Scan saved successfully!\n\nImage encrypted and uploaded to secure cloud.\nNever saved to device gallery (zero-footprint).\nEHR sync queued via FHIR R4.');
    }

    function exportPDF() {
        alert('üìÑ PDF report generated and pushed to Epic EMR via FHIR R4.\n\nReport includes:\n‚Ä¢ 3D measurements\n‚Ä¢ Tissue segmentation\n‚Ä¢ Treatment recommendation\n‚Ä¢ Healing trend');
    }

    function updateAnalytics() {
        setTimeout(drawHealingChart, 100);
    }

    // Simple canvas chart drawing
    function drawHealingChart() {
        const canvas = document.getElementById('healingChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.offsetWidth || 400;
        const H = canvas.height || 220;
        canvas.width = W;
        ctx.clearRect(0, 0, W, H);

        const data = [8.4, 8.2, 8.0, 7.9, 7.7, 7.4];
        const labels = ['Day 0', 'Day 7', 'Day 14', 'Day 21', 'Day 28', 'Day 42'];
        const threshold = 8.4 * 0.8; // 20% reduction threshold

        const pad = { top: 20, right: 20, bottom: 40, left: 50 };
        const w = W - pad.left - pad.right;
        const h = H - pad.top - pad.bottom;
        const maxVal = 10, minVal = 0;

        // Grid
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
            const y = pad.top + (h * i / 5);
            ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
            ctx.fillStyle = '#718096'; ctx.font = '11px sans-serif'; ctx.textAlign = 'right';
            ctx.fillText((maxVal - (maxVal * i / 5)).toFixed(0), pad.left - 6, y + 4);
        }

        // Threshold line
        const threshY = pad.top + h - (threshold / maxVal) * h;
        ctx.strokeStyle = '#fc8181';
        ctx.setLineDash([6, 3]);
        ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(pad.left, threshY); ctx.lineTo(W - pad.right, threshY); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#fc8181'; ctx.font = '10px sans-serif'; ctx.textAlign = 'left';
        ctx.fillText('20% reduction target', pad.left + 4, threshY - 3);

        // Area line
        ctx.strokeStyle = '#3182ce';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        data.forEach((v, i) => {
            const x = pad.left + (w * i / (data.length - 1));
            const y = pad.top + h - (v / maxVal) * h;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Dots
        data.forEach((v, i) => {
            const x = pad.left + (w * i / (data.length - 1));
            const y = pad.top + h - (v / maxVal) * h;
            ctx.fillStyle = '#3182ce';
            ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#2d3748'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(v + ' cm¬≤', x, y - 8);
            ctx.fillStyle = '#718096'; ctx.font = '10px sans-serif';
            ctx.fillText(labels[i], x, H - pad.bottom + 15);
        });
    }

    function drawDashboardChart() {
        const canvas = document.getElementById('etiologyChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.offsetWidth || 400;
        const H = 200;
        canvas.width = W;
        canvas.height = H;
        ctx.clearRect(0, 0, W, H);

        const data = [
            { label: 'Pressure Ulcer', value: 16, color: '#fc8181' },
            { label: 'Diabetic Foot', value: 12, color: '#f6ad55' },
            { label: 'Venous Leg', value: 8, color: '#68d391' },
            { label: 'Surgical Site', value: 4, color: '#76e4f7' },
            { label: 'Other', value: 2, color: '#b794f4' },
        ];
        const total = data.reduce((s, d) => s + d.value, 0);
        const cx = 100, cy = 100, r = 80;

        let startAngle = -Math.PI / 2;
        data.forEach(d => {
            const slice = (d.value / total) * Math.PI * 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, r, startAngle, startAngle + slice);
            ctx.fillStyle = d.color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            startAngle += slice;
        });

        // Legend
        let ly = 20;
        data.forEach(d => {
            ctx.fillStyle = d.color;
            ctx.fillRect(210, ly, 14, 14);
            ctx.fillStyle = '#2d3748';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`${d.label} (${d.value})`, 230, ly + 11);
            ly += 24;
        });
    }

    // Simulate offline/online toggle
    let offlineMode = false;
    setInterval(() => {
        // Randomly simulate connectivity changes for demo
    }, 30000);

    // Initialize
    setTimeout(drawDashboardChart, 200);

    // ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const API = '/api/v1';
    let authToken = sessionStorage.getItem('auth_token');
    let currentUser = JSON.parse(sessionStorage.getItem('current_user') || 'null');

    function initAuth() {
        if (!authToken) {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-nav').style.display = 'none';
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        } else {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            if (currentUser) document.getElementById('nav-user-name').textContent = currentUser.full_name || currentUser.email || '';
            loadUnreadAlerts();
        }
    }

    async function doLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errDiv = document.getElementById('login-error');
        errDiv.style.display = 'none';
        try {
            const resp = await fetch(API + '/auth/login', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({email, password})
            });
            if (!resp.ok) {
                // Dev mode: allow bypass if API not running
                if (resp.status >= 500) throw new Error('Server unavailable');
                const data = await resp.json();
                throw new Error(data.detail || 'Login failed');
            }
            const data = await resp.json();
            authToken = data.access_token;
            sessionStorage.setItem('auth_token', authToken);
            // Fetch user profile
            const meResp = await fetch(API + '/auth/me', {headers:{Authorization:'Bearer '+authToken}});
            if (meResp.ok) {
                currentUser = await meResp.json();
                sessionStorage.setItem('current_user', JSON.stringify(currentUser));
            }
            initAuth();
            showPage('dashboard');
        } catch(e) {
            // Dev bypass: if API isn't running, skip auth (DEVELOPMENT ONLY ‚Äî disable in production)
            if (e.message && e.message.includes('unavailable')) {
                authToken = 'dev-bypass';
                sessionStorage.setItem('auth_token', authToken);
                sessionStorage.setItem('current_user', JSON.stringify({full_name:'Dev User',role:'admin'}));
                currentUser = {full_name:'Dev User',role:'admin'};
                initAuth();
                showPage('dashboard');
                return;
            }
            errDiv.textContent = e.message;
            errDiv.style.display = 'block';
        }
    }

    function doLogout() {
        sessionStorage.removeItem('auth_token');
        sessionStorage.removeItem('current_user');
        authToken = null; currentUser = null;
        initAuth();
    }

    function authHeaders() {
        return authToken && authToken !== 'dev-bypass' ? {Authorization:'Bearer '+authToken} : {};
    }

    // ‚îÄ‚îÄ Alert Bell ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let alertDropdownOpen = false;
    function toggleAlertDropdown() {
        alertDropdownOpen = !alertDropdownOpen;
        const dd = document.getElementById('alert-dropdown');
        dd.classList.toggle('open', alertDropdownOpen);
        if (alertDropdownOpen) loadAlertDropdown();
    }

    async function loadUnreadAlerts() {
        try {
            const resp = await fetch(API + '/alerts/unread-count', {headers: authHeaders()});
            if (!resp.ok) return;
            const data = await resp.json();
            const badge = document.getElementById('alert-unread-count');
            if (data.unread_count > 0) {
                badge.textContent = data.unread_count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
            document.getElementById('alert-dropdown-count').textContent = data.unread_count ? `(${data.unread_count} unread)` : '';
        } catch(e) {}
    }

    async function loadAlertDropdown() {
        const list = document.getElementById('alert-dropdown-list');
        try {
            const resp = await fetch(API + '/alerts/', {headers: authHeaders()});
            if (!resp.ok) { list.innerHTML = '<div style="padding:16px;color:#718096;">Failed to load alerts</div>'; return; }
            const alerts = await resp.json();
            if (!alerts.length) { list.innerHTML = '<div style="padding:16px;color:#718096;text-align:center;">No alerts</div>'; return; }
            list.innerHTML = alerts.slice(0,10).map(a => `
                <div class="alert-item ${a.is_read ? '' : 'unread'}" onclick="markAlertRead('${a.id}')">
                    <div class="alert-type">${a.alert_type.replace(/_/g,' ')} ‚Ä¢ ${a.severity}</div>
                    <div class="alert-msg">${a.message.substring(0,120)}${a.message.length>120?'...':''}</div>
                </div>
            `).join('');
        } catch(e) { list.innerHTML = '<div style="padding:16px;color:#718096;">API unavailable</div>'; }
    }

    async function markAlertRead(alertId) {
        try {
            await fetch(API + '/alerts/'+alertId+'/read', {method:'PATCH', headers: authHeaders()});
            loadUnreadAlerts();
            loadAlertDropdown();
        } catch(e) {}
    }

    // ‚îÄ‚îÄ Patient Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let selectedPatientId = null;
    async function loadPatients() {
        try {
            const resp = await fetch(API + '/patients/', {headers: authHeaders()});
            if (!resp.ok) { renderPatientTable([]); return; }
            const patients = await resp.json();
            renderPatientTable(patients);
        } catch(e) { renderPatientTable([]); }
    }

    async function searchPatients(q) {
        if (!q || q.length < 2) { loadPatients(); return; }
        try {
            const resp = await fetch(API + '/patients/search?q='+encodeURIComponent(q), {headers: authHeaders()});
            if (!resp.ok) return;
            const patients = await resp.json();
            renderPatientTable(patients);
        } catch(e) {}
    }

    function renderPatientTable(patients) {
        const tbody = document.getElementById('patient-table-body');
        if (!patients.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#718096;padding:24px;">No patients found</td></tr>';
            return;
        }
        tbody.innerHTML = patients.map(p => `
            <tr>
                <td><strong>${p.first_name} ${p.last_name}</strong></td>
                <td><code>${p.mrn}</code></td>
                <td>${p.facility_id || '‚Äî'}</td>
                <td>‚Äî</td>
                <td>‚Äî</td>
                <td>
                    <button class="btn btn-primary" style="font-size:12px;padding:6px 12px;" onclick="viewPatientWounds('${p.id}','${p.first_name} ${p.last_name}')">View Wounds</button>
                </td>
            </tr>
        `).join('');
    }

    async function viewPatientWounds(patientId, patientName) {
        selectedPatientId = patientId;
        const card = document.getElementById('wound-summary-card');
        document.getElementById('wound-summary-title').textContent = `Wounds ‚Äî ${patientName}`;
        card.style.display = 'block';
        const list = document.getElementById('wound-summary-list');
        list.innerHTML = '<p style="color:#718096;">Loading wounds...</p>';
        try {
            const resp = await fetch(API + '/wounds/patient/'+patientId+'/summary', {headers: authHeaders()});
            if (!resp.ok) { list.innerHTML = '<p style="color:#c53030;">Failed to load wounds</p>'; return; }
            const wounds = await resp.json();
            if (!wounds.length) { list.innerHTML = '<p style="color:#718096;">No wounds for this patient.</p>'; return; }
            list.innerHTML = `<table>
                <thead><tr><th>Location</th><th>Etiology</th><th>Status</th><th>Severity Score</th><th>Stage</th><th>Last Assessment</th><th>Actions</th></tr></thead>
                <tbody>
                ${wounds.map(w => `
                    <tr>
                        <td>${w.body_location || '‚Äî'}</td>
                        <td>${w.etiology.replace(/_/g,' ')}</td>
                        <td><span class="badge ${w.status==='stalled'?'badge-red':w.status==='healing'?'badge-green':'badge-blue'}">${w.status}</span></td>
                        <td>${w.latest_severity_score != null ? `<span class="${severityClass(w.latest_severity_score)}" style="font-size:18px;font-weight:700;">${w.latest_severity_score.toFixed(1)}</span>` : '‚Äî'}</td>
                        <td>${w.latest_stage || '‚Äî'}</td>
                        <td>${w.last_assessment_date ? new Date(w.last_assessment_date).toLocaleDateString() : '‚Äî'}</td>
                        <td><button class="btn btn-outline" style="font-size:12px;padding:6px 12px;" onclick="viewWoundTimeline('${w.id}')">üìà Timeline</button></td>
                    </tr>
                `).join('')}
                </tbody>
            </table>`;
            card.scrollIntoView({behavior:'smooth'});
        } catch(e) { list.innerHTML = '<p style="color:#c53030;">API unavailable</p>'; }
    }

    function severityClass(score) {
        if (score < 2) return 'severity-low';
        if (score < 3.5) return 'severity-medium';
        return 'severity-high';
    }

    // ‚îÄ‚îÄ Wound Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let timelineChartInstance = null;
    async function viewWoundTimeline(woundId) {
        showPage('wound-timeline');
        const scanList = document.getElementById('timeline-scan-list');
        scanList.innerHTML = '<p style="color:#718096;">Loading timeline...</p>';
        try {
            const resp = await fetch(API + '/analytics/wound/'+woundId+'/timeline', {headers: authHeaders()});
            if (!resp.ok) { scanList.innerHTML = '<p style="color:#c53030;">Failed to load timeline</p>'; return; }
            const scans = await resp.json();
            renderTimelineChart(scans);
            renderTimelineScanList(scans);
        } catch(e) { scanList.innerHTML = '<p style="color:#c53030;">API unavailable ‚Äî showing demo data</p>'; renderDemoTimeline(); }
    }

    function renderTimelineChart(scans) {
        const ctx = document.getElementById('timeline-chart').getContext('2d');
        if (timelineChartInstance) timelineChartInstance.destroy();
        const labels = scans.map(s => new Date(s.created_at).toLocaleDateString());
        const scores = scans.map(s => s.severity_score);
        timelineChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Severity Score',
                    data: scores,
                    borderColor: '#3182ce',
                    backgroundColor: 'rgba(49,130,206,0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: scores.map(s => s >= 3.5 ? '#e53e3e' : s >= 2 ? '#d69e2e' : '#38a169'),
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `Severity: ${ctx.raw}` } } },
                scales: { y: { min: 0, max: 4, title: { display: true, text: 'Severity Score' } } }
            }
        });
    }

    function renderTimelineScanList(scans) {
        const list = document.getElementById('timeline-scan-list');
        list.innerHTML = scans.map(s => `
            <div class="timeline-item" style="margin-bottom:16px;padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <span class="timeline-date">${new Date(s.created_at).toLocaleString()}</span>
                        <div style="margin-top:4px;">
                            ${s.severity_score != null ? `<span class="${severityClass(s.severity_score)} severity-score-big" style="font-size:24px;">${s.severity_score.toFixed(1)}</span>` : ''}
                            ${s.stage_classification ? `<span class="badge badge-blue" style="margin-left:8px;">${s.stage_classification}</span>` : ''}
                            ${s.clinician_confirmed ? '<span class="badge badge-green" style="margin-left:8px;">‚úì Confirmed</span>' : '<span class="badge badge-yellow" style="margin-left:8px;">Pending Review</span>'}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        ${s.area_cm2 != null ? `<div style="font-size:13px;color:#718096;">${s.area_cm2.toFixed(2)} cm¬≤</div>` : ''}
                        ${s.par_from_baseline != null ? `<div style="font-size:13px;color:${s.par_from_baseline>=20?'#38a169':'#c53030'};">PAR: ${s.par_from_baseline.toFixed(1)}%</div>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderDemoTimeline() {
        const demoScans = [
            {created_at: new Date(Date.now()-21*86400000).toISOString(), severity_score: 3.2, stage_classification:'Stage 3', area_cm2:8.4, par_from_baseline:null, clinician_confirmed:true},
            {created_at: new Date(Date.now()-14*86400000).toISOString(), severity_score: 2.9, stage_classification:'Stage 3', area_cm2:7.1, par_from_baseline:15.5, clinician_confirmed:true},
            {created_at: new Date(Date.now()-7*86400000).toISOString(), severity_score: 2.5, stage_classification:'Stage 2', area_cm2:6.0, par_from_baseline:28.6, clinician_confirmed:false},
            {created_at: new Date().toISOString(), severity_score: 2.1, stage_classification:'Stage 2', area_cm2:5.2, par_from_baseline:38.1, clinician_confirmed:false},
        ];
        renderTimelineChart(demoScans);
        renderTimelineScanList(demoScans);
    }

    // ‚îÄ‚îÄ Admin Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadAuditLogs() {
        const tbody = document.getElementById('audit-log-tbody');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#718096;">Loading...</td></tr>';
        try {
            const resp = await fetch(API + '/admin/audit-logs?limit=50', {headers: authHeaders()});
            if (!resp.ok) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#c53030;">Admin access required</td></tr>'; return; }
            const logs = await resp.json();
            tbody.innerHTML = logs.map(l => `
                <tr>
                    <td>${new Date(l.created_at).toLocaleString()}</td>
                    <td>${(l.user_id || '').substring(0,8)}...</td>
                    <td>${l.action}</td>
                    <td>${l.resource_type}</td>
                    <td>${(l.resource_id || '').substring(0,8)}...</td>
                    <td>${l.ip_address || '‚Äî'}</td>
                </tr>
            `).join('');
        } catch(e) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#c53030;">API unavailable</td></tr>'; }
    }

    // ‚îÄ‚îÄ AI Results: Confirm / Override ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentScanId = null;
    function showConfirmOverride(scanId, severityScore, stage) {
        currentScanId = scanId;
        document.getElementById('current-severity-display').textContent = severityScore ? severityScore.toFixed(1) : 'N/A';
        document.getElementById('current-stage-display').textContent = stage || 'N/A';
        document.getElementById('confirm-override-panel').style.display = 'block';
    }

    async function confirmScan() {
        if (!currentScanId) return;
        try {
            const resp = await fetch(API + '/scans/'+currentScanId+'/confirm', {
                method: 'PATCH',
                headers: {...authHeaders(), 'Content-Type':'application/json'},
                body: JSON.stringify({confirmed_by: currentUser?.id || 'clinician'})
            });
            if (resp.ok) {
                alert('‚úÖ Scan confirmed by clinician.');
                document.getElementById('confirm-override-panel').style.display = 'none';
            }
        } catch(e) { alert('Confirm failed: ' + e.message); }
    }

    async function overrideScan() {
        if (!currentScanId) return;
        const reason = prompt('Enter override reason:');
        if (!reason) return;
        const newScore = prompt('Override severity score (leave blank to keep AI score):');
        const newStage = prompt('Override stage (leave blank to keep AI stage):');
        try {
            const body = {
                override_reason: reason,
                confirmed_by: currentUser?.id || 'clinician',
            };
            if (newScore) body.override_severity_score = parseFloat(newScore);
            if (newStage) body.override_stage = newStage;
            const resp = await fetch(API + '/scans/'+currentScanId+'/override', {
                method: 'PATCH',
                headers: {...authHeaders(), 'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            if (resp.ok) {
                alert('‚úÖ AI result overridden and documented.');
                document.getElementById('confirm-override-panel').style.display = 'none';
            }
        } catch(e) { alert('Override failed: ' + e.message); }
    }

    // ‚îÄ‚îÄ Override showPage to handle new pages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _origShowPage = showPage;
    window.showPage = function(page) {
        // Close alert dropdown
        alertDropdownOpen = false;
        document.getElementById('alert-dropdown').classList.remove('open');
        _origShowPage(page);
        if (page === 'patients') { showPage('patients-dashboard'); return; }
        if (page === 'patients-dashboard') loadPatients();
        if (page === 'wound-timeline') {} // handled by viewWoundTimeline
        if (page === 'admin') loadAuditLogs();
    };

    // ‚îÄ‚îÄ Camera capture using getUserMedia ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let cameraStream = null;
    async function startCamera() {
        const videoEl = document.getElementById('camera-video');
        if (!videoEl) return;
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({video: {facingMode:'environment'}, audio: false});
            videoEl.srcObject = cameraStream;
            videoEl.play();
            document.getElementById('camera-placeholder').style.display = 'none';
            videoEl.style.display = 'block';
            document.getElementById('capture-btn').style.display = 'inline-block';
        } catch(e) {
            document.getElementById('camera-placeholder').innerHTML = '<div class="camera-icon">üì∑</div><p>Camera access denied or unavailable.<br>Please use the file upload instead.</p>';
        }
    }

    function capturePhoto() {
        const videoEl = document.getElementById('camera-video');
        if (!videoEl || !cameraStream) return;
        const canvas = document.createElement('canvas');
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        canvas.getContext('2d').drawImage(videoEl, 0, 0);
        canvas.toBlob(blob => {
            const file = new File([blob], 'wound-capture.jpg', {type:'image/jpeg'});
            const dt = new DataTransfer();
            dt.items.add(file);
            const fileInput = document.getElementById('scan-image-input');
            if (fileInput) fileInput.files = dt.files;
            document.getElementById('capture-preview').innerHTML = `<img src="${URL.createObjectURL(blob)}" style="max-width:200px;border-radius:8px;"/>`;
            document.getElementById('camera-captured-indicator').style.display = 'block';
        }, 'image/jpeg', 0.9);
    }

    // ‚îÄ‚îÄ Initialize on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
        // Show login if not authenticated
        initAuth();
        // Refresh alert count every 60s
        setInterval(loadUnreadAlerts, 60000);
    });
</script>
</body>
</html>
